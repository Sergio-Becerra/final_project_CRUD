AWSTemplateFormatVersion: "2010-09-09"

Resources:        

  TaskRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - ecs-tasks.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: "/"
      RoleName: crud-sabc-ecs-task-role
      Policies:
      - PolicyName: crud-sabc-policy-read-secrets
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - "secretsmanager:GetSecretValue"
            Resource: 
              - !ImportValue SecretDB
      - PolicyName: crud-sabc-policy-read-ssm
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - "ssm:GetParameter"
            Resource: 
              -  "*"
      - PolicyName: crud-sabc-policy-ecr
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - "ecr:GetAuthorizationToken"
            - "ecr:BatchCheckLayerAvailability"
            - "ecr:GetDownloadUrlForLayer"
            - "ecr:BatchGetImage"
            - "logs:CreateLogStream"
            - "logs:PutLogEvents"
            Resource: 
              -  "*"

  ECSService: 
    Type: AWS::ECS::Service
    Properties: 
      Cluster: !ImportValue CrudECS
      LoadBalancers:
        - ContainerName: "clip_crud_project_sabc_container"
          ContainerPort: 8080
          TargetGroupArn: !Ref AppTargetGroup
      DesiredCount: 2
      TaskDefinition: !Ref CrudTasKDefinition 

  CrudTasKDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      TaskRoleArn: !GetAtt TaskRole.Arn
      ContainerDefinitions:
        - 
          Name: "clip_crud_project_sabc_container"
          Image: 109832253823.dkr.ecr.us-west-2.amazonaws.com/test-sabc:latest
          PortMappings:
            -
              ContainerPort: 8080
              HostPort: 0
              Protocol: "tcp"
          Environment:
            - Name: AWS_DEFAULT_REGION
              Value: !Ref AWS::Region
      Cpu: "256"
      Memory: "512"
      Tags:
        - Key: Name
          Value: "clip_crud_project_sabc_task_definition"

  LBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref AppTargetGroup
      LoadBalancerArn: !ImportValue  AppLBE
      Port: 8080
      Protocol: "HTTP"

  AppTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: "Crud-project-sabc"
      Port: 8080
      Protocol: "HTTP"
      TargetType: "instance"
      VpcId: !ImportValue CrudVPC
      Tags:
        - Key: Name
          Value: crud-sabc-tg

